<!DOCTYPE html>
<html>
<head>
    <title>使用标准程序加载 WASM 模块</title>
</head>
<body>
  <p><span>排序前：</span><span class="sequence-before"></span></p>
  <p><span>排序后：</span><span class="sequence"></span></p>
<script type="text/javascript">
// 将 JS 生成的数组数据填充到指定的内存中；
function importArrayToBuffer (memory, array, offset) {
  const importBuffer = new Uint32Array(memory.buffer, offset, array.lenth);
  for (let i = 0; i < array.length; i++) {
    importBuffer[i] = array[i];
  }
}



let startTime = performance.now()
WebAssembly.instantiateStreaming(fetch('original.wasm'), {
  env: {
    print (offset, len) {
      let strBuffer = new Uint32Array(memory.buffer, offset, len);
      console.log(strBuffer);
    }
  }
}).then(resultObject => {
	console.log(performance.now() - startTime);
	console.log(resultObject)
});



/*
let startTime = performance.now()
WebAssembly.compileStreaming(fetch('original.wasm')).then(module => WebAssembly.instantiate(module, {
  env: {
    // 需要导入到模块中的JavaScript函数；
    print (offset, len) {
      let strBuffer = new Uint32Array(memory.buffer, offset, len);
      document.querySelector('.sequence').innerText = JSON.stringify(Object.values(strBuffer));
    }
  }
})).then(resultObject => {
	console.log(performance.now() - startTime);
	console.log(resultObject)
});
*/



/*
let startTime = performance.now()
fetch('original.wasm').then(response => response.arrayBuffer()).then((bytes) => {
  let memory;
// 通过浏览器提供的标准 WebAssembly 接口来编译和初始化一个 WASM模块；
  WebAssembly.compile(bytes).then(module => WebAssembly.instantiate(module, {
    env: {
      // 需要导入到模块中的JavaScript函数；
      print (offset, len) {
        let strBuffer = new Uint32Array(memory.buffer, offset, len);
        document.querySelector('.sequence').innerText = JSON.stringify(Object.values(strBuffer));
      }
    }
  })).then(instance => {
  	console.log(performance.now() - startTime);

    // 取出从WASM模块中导出的函数；
    let exports = instance.exports;
    // 获得该WASM模块实例所使用的堆内存对象；
    memory = exports.memory;
    let arr = [];
    // 生成一个包含十个元素的整型数组；
    for (let i = 0; i < 10; i++) {
      arr.push(Math.round(Math.random() * 10));
    }
    document.querySelector('.sequence-before').innerText = JSON.stringify(arr);
    // 将整型数组的元素依次填充到指定的内存段中，即填充到WASM模块初始化时所生成的数组中；
    importArrayToBuffer(memory, arr, exports.getArrayOffset());
    // 调用WASM模块暴露出的排序函数；
    exports.sort();
    });
});
*/


</script>
</body>
</html>